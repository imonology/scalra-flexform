<% layout('template/common') %>
<% block('title').append('<title>'+(typeof(title)!=='undefined' ? title : 'List')+'</title>') %>
	
<script src="/web/flexform/jquery.tagsinput.js"></script>


<script>
<%
var f1 = encodeURIComponent(JSON.stringify(para));
var forms = {};
var error = false;
var error_message = '';
// var form_count = 0;
function l_query_form(para) {
	return function(onD) {
		l_do_query_form(para, onD);
	}
}
function l_do_query_form(p, onDone) {
	var i = p.use_page;
	LOG.warn('i = ' + i);
	LOG.warn(para);
	SR.API.QUERY_FORM( para[i].form_query, function (err, form) {
		if (err) {
			error = true;
			error_message = err;
			return err;
		}
		
		if (typeof(para[i].default_value) !== 'undefined') {
			var default_keys = Object.keys(para[i].default_value);
			for (var j in form.data.fields) {
				for (var k in default_keys) {
					if (form.data.fields[j].id === default_keys[k]) {
						form.data.fields[j].default_value = para[i].default_value[default_keys[k]];
					}
				}
			}
		}
		
		forms[i] = [];
		var clone_f = JSON.parse(JSON.stringify(form));
		forms[i].push(clone_f);
		
		if (!para[i].related_form) {
			add_data(forms[i].length -1);
		}
		
		var related_form_count = 0;
		for (var j in para[i].related_form){
			SR.API.QUERY_FORM( para[i].related_form[j].form_query, function (err, form) {
				if (err) {
					error = true;
					error_message = err;
					return err;
				}
				var clone_f = JSON.parse(JSON.stringify(form));
				forms[i].push(clone_f);
				related_form_count++;
				if (related_form_count === para[i].related_form.length) {
					
					return onDone(null);
				}
			});
		}
		
		function add_data(form_position) { // 從其他form新增資料
			if (typeof(para[i].add_data) !== 'undefined') {
				LOG.warn('需要新增資料的form');
				var pointers = Object.keys(forms[i][form_position].data.values); // 新增資料 指向的record_id
				
				var jq2 = SR.JobQueue.createQueue();
				
				for (var j in para[i].add_data) {
					// {form_name: 'CaseOwner', pointer: 'case_form_id', add_id: ['name']},
					
					jq2.add(l_add_form({add_para: para[i].add_data[j]}));
					
					function l_add_form(l_add_form_para) {
						return function(onD) {
							l_do_add_form(l_add_form_para, onD);
						}
					}
					function l_do_add_form(l_add_form_para, onDone2) {
						var add_para = l_add_form_para.add_para;
						SR.API.QUERY_FORM( {name: add_para.form_name}, function (err, add_form) {
							if (err) {
								error = true;
								error_message = err;
								return err;
							}
							// 先塞入field內容
							for (var k in add_form.data.fields) {
								for (var l in add_para.add_id) {
									if (add_form.data.fields[k].id === add_para.add_id[l]) {
										forms[i][form_position].data.fields.push(add_form.data.fields[k]);			
									}
								}
							}
							// 依照pointer和需要的record_id塞入data
							for (var record_id in add_form.data.values) {
								for (var k in pointers) {
									if (add_form.data.values[record_id][add_para.pointer] === pointers[k]) {
										LOG.warn('找到');
										// LOG.warn(add_form.data.values[record_id])
										for (var l in add_para.add_id) {
											LOG.warn( add_form.data.values[record_id][add_para.add_id[l]] );
											forms[i][form_position].data.values[pointers[k]][add_para.add_id[l]] = add_form.data.values[record_id][add_para.add_id[l]];
										}
									}
								}
							}
							return onDone2(null);
						});
						
					}
				}
				
				jq2.run(function (err) {
					
					return onDone(null);
				});
				// LOG.warn(forms[i][form_position].data.values)
				// LOG.warn(para[i].add_data);
				
				
			} else {
				return onDone(null);
			}
		}
		
	});
}
var jq = SR.JobQueue.createQueue();
for (var i in para)	{
	jq.add(l_query_form({use_page: i}));
}
jq.run(function (err) {
	var f2 = encodeURIComponent(JSON.stringify(forms));
	%> 
		var para = JSON.parse(decodeURIComponent("<%-f1 %>")); 
		var forms = JSON.parse(decodeURIComponent("<%-f2 %>")); 
		var use_page = 0;
	<%	
});	
%>

var add_forms = {};
var onConnect = function () {
	init_tab();
	init_html(init_onDone);
}

function init_onDone(err, html) {
	document.getElementById('sub_title').innerHTML = para[use_page].s_title;
	document.getElementById('form_area').innerHTML = html;	

	init_submit_btn();
	enable_js();
}

function init_tab() {
	var html = '';
	html += '<ul class="tabs">';
	for (var i in para) {
		html += '<li '+(i==='0'?'class="active"': '')+' onclick="switch_tab('+i+')">'+para[i].s_title+'</li>';
	}
	html += '</ul>';
	html += '<div style="clear:both;"></div>';
	document.getElementById('tab_area').innerHTML = html;	
}

function switch_tab(n) {
	use_page = parseInt(n);

	init_html(init_onDone);
}

function init_html(onDone) {
	if (para[use_page].type === 'view') {
		init_view(onDone);
	} else if (para[use_page].type === 'list') {
		init_list(onDone);
	}
}
		
function init_list(onDone) {
	var flextable_data = SR.API.flexform_to_flexform_table({form: forms[use_page][0]}); // 目前list只支援顯示一個form
	
	var html = flexform_show_table_v3( flextable_data, {hide: para[use_page].hide } ) ;
	return onDone(null, html);
}
		
// 底下是view

function init_view(onDone) {
	var html = '';
	
	var page_forms = forms[use_page];
	for (var i in page_forms) {
		if (i !== '0') {
			add_forms[(parseInt(i)-1)] = [];
			html += '<hr>'
			html += '<div class="add_expansion_title">';
			html += '<div class="expansion_form_id"><p class="form_title">' + para[use_page].related_form[(parseInt(i)-1)].form_title + '</p></div>';
			html += '<div class="add_expansion_form" onclick="add_expansion_form('+(parseInt(i-1))+')"><span class="plus_btn">+</span></div>';
			html += '</div>';
		}
		if (i === '0') {
			html += '<div id="main_form">';
		} else {
			html += '<div id="expansion_form_'+(parseInt(i)-1)+'">';
		}

		if (para[use_page].mode === 'new') {
			page_forms[i].data.values = {};
		}
		html += create_table_v3(page_forms[i], get_form_para());

		html += '</div>';

	}
	
	return onDone(null, html);
}
		
function init_submit_btn() {
	if (para[use_page].mode !== 'show') {
		document.getElementById('button_area').innerHTML = 	'<button class="btn btn-primary" onClick="check_upload_v3()">送出</button>';
	} else {
		document.getElementById('button_area').innerHTML = '';
	}
}
		
function enable_js() {
	$('ul.tabs li').click(function() {
		var $this = $(this), _clickTab = $this.find('a').attr('href');
		$this.addClass('active').siblings('.active').removeClass('active');
	});
	if (typeof(date_pickers) !== 'undefined') {
		for (var i=0; i < date_pickers.length; i++) {
			$(function() {
				$("#" + date_pickers[i]).datepicker(datepicker_setting);
			});
		}
	}
	$('.tags').tagsInput();
	
}

function get_form_para() {
	var form_para = {};
	if (typeof(para[use_page].customized)!=='undefined' && para[use_page].customized) {
		form_para.customized = para[use_page].customized;
	}
	form_para.hide = para[use_page].hide;
	if (para[use_page].mode === 'show') {
		form_para.write = false;
	} else {
		form_para.write = true;
	}
	return form_para;
}
		
function get_new_expansion_form_number(n) { // 取得第n個expansion_form的新號碼
	for (var i = 0 ; i <= add_forms[n].length ; i++) {
		if (add_forms[n].indexOf(i) === -1) {
			return i;
		}
	}
}
		
function add_expansion_form(n) {
	var expansion_form_number = get_new_expansion_form_number(n);
	var html = '<div id="expansion_form_'+n+'-'+expansion_form_number+'">';
	html += '<hr>';
	html += '<div class="add_expansion_title">';
	html += '<div class="expansion_form_id"><p class="form_title">' + para[use_page].related_form[n].form_title + '</p></div>';
	html += '<div class="minus_expansion_form" onclick="minus_expansion_form('+n+', '+expansion_form_number+')"><span class="plus_btn">-</span></div>';
	var form_para = get_form_para();
	form_para.id_num = expansion_form_number;
	html += create_table_v3(forms[use_page][n+1], form_para);
	html += '</div>';
	add_forms[n].push(expansion_form_number);
	document.getElementById("expansion_form_"+n).innerHTML += html;
	enable_js();
}
		
function minus_expansion_form(n, expansion_form_number) {
	
	$("#expansion_form_"+n+"-"+expansion_form_number).remove();
	add_forms[n].splice(add_forms[n].indexOf(expansion_form_number), 1);
}

</script>

<div id="container">
	<%	if (typeof nav !== 'undefined') { %>
		<% include nav %>
	<% } %>

	<div id="mainContent">
		<section id="three" class="wrapper style2 special">
			<div class="inner">
				<div id="tab_area"></div>
				<h2 id='sub_title'></h2>
				<div id="form_area"></div>
				<div id="button_area"></div>
			</div>
		</section>
	</div>
</div>
