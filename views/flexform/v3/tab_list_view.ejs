<% layout('template/common') %>
<% block('title').append('<title>'+(typeof(title)!=='undefined' ? title : 'List')+'</title>') %>
	
<script src="/web/flexform/jquery.tagsinput.js"></script>


<script>
<%
var f1 = encodeURIComponent(JSON.stringify(para));
var forms = [];
var error = false;
var error_message = '';
for (var i in para)	{
	SR.API.QUERY_FORM( para[i].form_query, function (err, form) {
		if (err) {
			error = true;
			error_message = err;
			return err;
		}
		forms.push(form);
		var related_form_count = 0;
		for (var j in para[i].related_form){
			SR.API.QUERY_FORM( para[i].related_form[j].form_query, function (err, form) {
				if (err) {
					error = true;
					error_message = err;
					return err;
				}
				forms.push(form);
				related_form_count++;
				if (related_form_count === para[i].related_form.length) {
					var f2 = encodeURIComponent(JSON.stringify(forms));
					%> 
						var para = JSON.parse(decodeURIComponent("<%-f1 %>")); 
						var forms = JSON.parse(decodeURIComponent("<%-f2 %>")); 
						var use_page = 0;
					<%
				}
			});
		}
	});
}
%>

var add_forms = {};
var onConnect = function () {
	init_tab();
	init_html(function(err, html){
		document.getElementById('sub_title').innerHTML = para[use_page].s_title;
		document.getElementById('form_area').innerHTML = html;	
		if (typeof(date_pickers) !== 'undefined') {
			for (var i=0; i < date_pickers.length; i++) {
				$(function() {
					$("#" + date_pickers[i]).datepicker(datepicker_setting);
				});
			}
		}
		$('.tags').tagsInput();
		init_submit_btn();
		enable_js();
	});
}

function init_tab() {
	var html = '';
	html += '<ul class="tabs">';
	html += '<li class="active">個案建立</li>';
	html += '<li>派案管理</li>';
	html += '<li>案件管理</li>';
	html += '</ul>';
	html += '<div style="clear:both;"></div>';
	// html += '<p>123</p>';
	document.getElementById('tab_area').innerHTML = html;	
}

function init_html(onDone) {
	var html = '';
	for (var i in forms) {
		if (i !== '0') {
			add_forms[(parseInt(i)-1)] = [];
			html += '<hr>'
			html += '<div class="add_expansion_title">';
			html += '<div class="expansion_form_id"><p class="form_title">' + para[use_page].related_form[(parseInt(i)-1)].form_title + '</p></div>';
			html += '<div class="add_expansion_form" onclick="add_expansion_form('+(parseInt(i)-1)+')"><span class="plus_btn">+</span></div>';
			html += '</div>';
		}
		if (i === '0') {
			html += '<div id="main_form">';
		} else {
			html += '<div id="expansion_form_'+(parseInt(i)-1)+'">';
		}
		
		html += create_table_v3(forms[i], get_form_para());

		html += '</div>';

	}
	
	return onDone(null, html);
}
		
function init_submit_btn() {
	document.getElementById('button_area').innerHTML = 	'<button class="btn btn-primary" onClick="">送出</button>';
}
		
function enable_js() {
	$('ul.tabs li').click(function() {
		var $this = $(this), _clickTab = $this.find('a').attr('href');
		$this.addClass('active').siblings('.active').removeClass('active');
	});
}

function get_form_para() {
	var form_para = {};
	if (typeof(para[use_page].customized)!=='undefined' && para[use_page].customized) {
		form_para.customized = para[use_page].customized;
	}
	if (para[use_page].mode === 'show') {
		form_para.write = false;
	} else {
		form_para.write = true;
	}
	return form_para;
}
		
function get_new_expansion_form_number(n) { // 取得第n個expansion_form的新號碼
	for (var i = 0 ; i <= add_forms[n].length ; i++) {
		if (add_forms[n].indexOf(i) === -1) {
			return i;
		}
	}
}
		
function add_expansion_form(n) {
	var expansion_form_number = get_new_expansion_form_number(n);
	var html = '<div id="expansion_form_'+n+'-'+expansion_form_number+'">';
	html += '<hr>';
	html += '<div class="add_expansion_title">';
	html += '<div class="expansion_form_id"><p class="form_title">' + para[use_page].related_form[n].form_title + '</p></div>';
	html += '<div class="minus_expansion_form" onclick="minus_expansion_form('+n+', '+expansion_form_number+')"><span class="plus_btn">-</span></div>';
	html += create_table_v3(forms[(n+1).toString()], get_form_para());
	html += '</div>';
	add_forms[n].push(expansion_form_number);
	document.getElementById("expansion_form_"+n).innerHTML += html;
}
		
function minus_expansion_form(n, expansion_form_number) {
	
	$("#expansion_form_"+n+"-"+expansion_form_number).remove();
	add_forms[n].splice(add_forms[n].indexOf(expansion_form_number), 1);
}

</script>

<div id="container">
	<%	if (typeof nav !== 'undefined') { %>
		<% include nav %>
	<% } %>

	<div id="mainContent">
		<section id="three" class="wrapper style2 special">
			<div class="inner">
				<div id="tab_area"></div>
				<h2 id='sub_title'></h2>
				<div id="form_area"></div>
				<div id="button_area"></div>
			</div>
		</section>
	</div>
</div>
